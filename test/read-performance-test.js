const fs = require('fs/promises');
const path = require('path');
const { read } = require('../');

/**
 * Performance test for reading individual images from CharPack files
 * Tests the average time to read a single image variation from memory
 */
async function runReadPerformanceTest() {
    console.log('CharPack Read Performance Test');
    console.log('==============================\n');

    // Use the test CharPack file generated by pack-test.js
    const charpackPath = path.join(__dirname, 'output', 'test-pack-glob.charpack');

    try {
        // Check if the CharPack file exists
        await fs.access(charpackPath);
    } catch (error) {
        console.error(`CharPack file not found: ${charpackPath}`);
        console.log('Please run pack-test.js first to generate the test file.');
        return;
    }

    console.log(`Loading CharPack file: ${charpackPath}`);

    // Load CharPack into memory for efficient reading
    const memoryPack = await read(charpackPath);
    console.log('CharPack loaded into memory successfully.\n');

    // Get variation names from the file (we need to deserialize to get them)
    const buffer = await fs.readFile(charpackPath);
    const { deserialize } = require('../');
    const charPackData = deserialize(buffer);
    const variations = charPackData.variations.map(v => v.name);

    console.log(`Found ${variations.length} variations:`);
    variations.forEach(name => console.log(`  - ${name}`));
    console.log();

    // Configuration for the performance test
    const iterationsPerVariation = 10; // Number of times to read each variation
    const format = 'png'; // Format to test (png, jpeg, webp, base64)

    console.log(`Performance Test Configuration:`);
    console.log(`  - Iterations per variation: ${iterationsPerVariation}`);
    console.log(`  - Format tested: ${format}`);
    console.log(`  - Total reads: ${variations.length * iterationsPerVariation}\n`);

    // Run performance test
    const results = [];

    for (const variation of variations) {
        console.log(`Testing variation: ${variation}`);

        const times = [];

        // Perform multiple reads and measure time
        for (let i = 0; i < iterationsPerVariation; i++) {
            const startTime = process.hrtime.bigint();

            // Read the image (in memory operation)
            const imageBuffer = await memoryPack[format](variation);

            const endTime = process.hrtime.bigint();
            const durationMs = Number(endTime - startTime) / 1_000_000; // Convert to milliseconds
            times.push(durationMs);
        }

        // Calculate statistics for this variation
        const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
        const minTime = Math.min(...times);
        const maxTime = Math.max(...times);

        results.push({
            variation,
            avgTime,
            minTime,
            maxTime,
            iterations: times.length
        });

        console.log(`  Average: ${avgTime.toFixed(3)}ms, Min: ${minTime.toFixed(3)}ms, Max: ${maxTime.toFixed(3)}ms`);
    }

    // Calculate overall statistics
    const overallAvgTime = results.reduce((sum, result) => sum + result.avgTime, 0) / results.length;
    const overallMinTime = Math.min(...results.map(r => r.minTime));
    const overallMaxTime = Math.max(...results.map(r => r.maxTime));

    console.log('\nOverall Results:');
    console.log('================');
    console.log(`Average read time per image: ${overallAvgTime.toFixed(3)}ms`);
    console.log(`Fastest read: ${overallMinTime.toFixed(3)}ms`);
    console.log(`Slowest read: ${overallMaxTime.toFixed(3)}ms`);
    console.log(`Total variations tested: ${results.length}`);
    console.log(`Total read operations: ${results.length * iterationsPerVariation}`);

    // Get file size for context
    const stats = await fs.stat(charpackPath);
    console.log(`CharPack file size: ${stats.size} bytes`);

    // Cleanup
    memoryPack.dispose();

    console.log('\nPerformance test completed.');
}

// Run the test
if (require.main === module) {
    runReadPerformanceTest().catch(error => {
        console.error('Test failed:', error.message);
        process.exit(1);
    });
}

module.exports = { runReadPerformanceTest };
