const fs = require('fs/promises');
const path = require('path');
const { extract } = require('../');

/**
 * Performance test for extracting individual images from CharPack files using extract()
 * Each extraction reads from disk every time
 */
async function runExtractPerformanceTest() {
    console.log('CharPack Extract Performance Test (Disk Reads)');
    console.log('===============================================\n');

    // Use the test CharPack file generated by pack-test.js
    const charpackPath = path.join(__dirname, 'output', 'test-pack-glob.charpack');

    try {
        // Check if the CharPack file exists
        await fs.access(charpackPath);
    } catch (error) {
        console.error(`CharPack file not found: ${charpackPath}`);
        console.log('Please run pack-test.js first to generate the test file.');
        return;
    }

    console.log(`Testing CharPack file: ${charpackPath}`);

    // Get variation names from the file (we need to deserialize to get them)
    const buffer = await fs.readFile(charpackPath);
    const { deserialize } = require('../');
    const charPackData = deserialize(buffer);
    const variations = charPackData.variations.map(v => v.name);

    console.log(`Found ${variations.length} variations:`);
    variations.slice(0, 5).forEach(name => console.log(`  - ${name}`));
    if (variations.length > 5) {
        console.log(`  ... and ${variations.length - 5} more`);
    }
    console.log();

    // Configuration for the performance test
    const iterationsPerVariation = 10; // Number of times to extract each variation
    const format = 'png'; // Format to test (png, jpeg, webp, base64)
    const testVariations = variations.slice(0, 10); // Test only first 10 variations to keep test reasonable

    console.log(`Performance Test Configuration:`);
    console.log(`  - Iterations per variation: ${iterationsPerVariation}`);
    console.log(`  - Format tested: ${format}`);
    console.log(`  - Variations to test: ${testVariations.length} (of ${variations.length} total)`);
    console.log(`  - Total extractions: ${testVariations.length * iterationsPerVariation}`);
    console.log(`  - Each extraction reads from disk\n`);

    // Run performance test
    const results = [];

    for (const variation of testVariations) {
        console.log(`Testing variation: ${variation}`);

        const times = [];

        // Perform multiple extractions and measure time
        for (let i = 0; i < iterationsPerVariation; i++) {
            const startTime = process.hrtime.bigint();

            // Extract the image (reads from disk every time)
            const charPack = await extract(charpackPath, variation);
            const imageBuffer = await charPack[format]();

            const endTime = process.hrtime.bigint();
            const durationMs = Number(endTime - startTime) / 1_000_000; // Convert to milliseconds
            times.push(durationMs);
        }

        // Calculate statistics for this variation
        const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
        const minTime = Math.min(...times);
        const maxTime = Math.max(...times);

        results.push({
            variation,
            avgTime,
            minTime,
            maxTime,
            iterations: times.length
        });

        console.log(`  Average: ${avgTime.toFixed(3)}ms, Min: ${minTime.toFixed(3)}ms, Max: ${maxTime.toFixed(3)}ms`);
    }

    // Calculate overall statistics
    const overallAvgTime = results.reduce((sum, result) => sum + result.avgTime, 0) / results.length;
    const overallMinTime = Math.min(...results.map(r => r.minTime));
    const overallMaxTime = Math.max(...results.map(r => r.maxTime));

    console.log('\nOverall Results:');
    console.log('================');
    console.log(`Average extraction time per image: ${overallAvgTime.toFixed(3)}ms`);
    console.log(`Fastest extraction: ${overallMinTime.toFixed(3)}ms`);
    console.log(`Slowest extraction: ${overallMaxTime.toFixed(3)}ms`);
    console.log(`Variations tested: ${results.length}`);
    console.log(`Total extractions: ${results.length * iterationsPerVariation}`);

    // Get file size for context
    const stats = await fs.stat(charpackPath);
    console.log(`CharPack file size: ${stats.size} bytes`);

    console.log('\nNote: Each extraction reads the entire CharPack file from disk,');
    console.log('      deserializes it, reconstructs the image, and encodes it.');

    console.log('\nDisk-based extraction test completed.');
}

// Run the test
if (require.main === module) {
    runExtractPerformanceTest().catch(error => {
        console.error('Test failed:', error.message);
        process.exit(1);
    });
}

module.exports = { runExtractPerformanceTest };
