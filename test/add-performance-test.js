const fs = require('fs/promises');
const path = require('path');
const { read, charpack } = require('../');

/**
 * Performance test for adding variations to CharPack files
 * Tests the time taken to add new image variations and repack the file
 */
async function runAddPerformanceTest() {
    console.log('CharPack Add Performance Test');
    console.log('=============================\n');

    // Use the test CharPack file generated by pack-test.js
    const charpackPath = path.join(__dirname, 'output', 'test-pack-glob.charpack');
    const tempCharpackPath = path.join(__dirname, 'output', 'test-add-temp.charpack');

    try {
        // Check if the CharPack file exists
        await fs.access(charpackPath);
    } catch (error) {
        console.error(`CharPack file not found: ${charpackPath}`);
        console.log('Please run pack-test.js first to generate the test file.');
        return;
    }

    // Copy the original file for testing (to avoid modifying the original)
    await fs.copyFile(charpackPath, tempCharpackPath);

    console.log(`Using CharPack file: ${tempCharpackPath}`);

    // Load CharPack into memory
    const memoryPack = await read(tempCharpackPath);
    console.log('CharPack loaded into memory successfully.\n');

    // Get current variation names
    const initialVariations = await memoryPack.list();
    console.log(`Initial variations: ${initialVariations.length}`);
    initialVariations.forEach(name => console.log(`  - ${name}`));
    console.log();

    // Get some test images to add (use a few from the input directory)
    const inputDir = path.join(__dirname, 'ignored', 'input');
    const allInputFiles = await fs.readdir(inputDir);
    const pngFiles = allInputFiles.filter(f => f.endsWith('.png')).slice(0, 10); // Use first 10 files

    // Create test images in a temporary location (copy existing ones with new names)
    const tempInputDir = path.join(__dirname, 'output', 'temp-add-input');
    await fs.mkdir(tempInputDir, { recursive: true });

    const testImages = [];
    for (let i = 0; i < pngFiles.length; i++) {
        const srcPath = path.join(inputDir, pngFiles[i]);
        const newName = `add-test-${i}.png`;
        const destPath = path.join(tempInputDir, newName);

        await fs.copyFile(srcPath, destPath);
        testImages.push(destPath);
    }

    console.log(`Prepared ${testImages.length} test images for adding.\n`);

    // Configuration for the performance test
    const testScenarios = [
        { name: 'Add single image', images: [testImages[0]], iterations: 1 },
        { name: 'Add multiple images (3)', images: testImages.slice(0, 3), iterations: 1 },
        { name: 'Add multiple images (5)', images: testImages.slice(0, 5), iterations: 1 },
    ];

    console.log('Performance Test Configuration:');
    console.log('===============================\n');

    // Run performance tests for each scenario
    const results = [];

    for (const scenario of testScenarios) {
        console.log(`Testing scenario: ${scenario.name}`);

        const times = [];

        for (let i = 0; i < scenario.iterations; i++) {
            // Create a fresh copy for each iteration
            const iterationPath = path.join(__dirname, 'output', `test-add-iteration-${i}.charpack`);
            await fs.copyFile(tempCharpackPath, iterationPath);

            // Load the fresh copy
            const iterationPack = await read(iterationPath);

            const startTime = process.hrtime.bigint();

            // Add the images
            await iterationPack.add(scenario.images);

            const endTime = process.hrtime.bigint();
            const durationMs = Number(endTime - startTime) / 1_000_000; // Convert to milliseconds
            times.push(durationMs);

            // Cleanup iteration file
            iterationPack.dispose();
            await fs.unlink(iterationPath);

            console.log(`  Iteration ${i + 1}: ${durationMs.toFixed(3)}ms`);
        }

        // Calculate statistics for this scenario
        const avgTime = times.reduce((a, b) => a + b, 0) / times.length;
        const minTime = Math.min(...times);
        const maxTime = Math.max(...times);

        results.push({
            scenario: scenario.name,
            imageCount: scenario.images.length,
            avgTime,
            minTime,
            maxTime,
            iterations: times.length
        });

        console.log(`  Average: ${avgTime.toFixed(3)}ms, Min: ${minTime.toFixed(3)}ms, Max: ${maxTime.toFixed(3)}ms\n`);
    }

    // Display final results
    console.log('Final Results Summary:');
    console.log('======================');

    results.forEach(result => {
        const timePerImage = result.avgTime / result.imageCount;
        console.log(`${result.scenario}:`);
        console.log(`  Images: ${result.imageCount}`);
        console.log(`  Average time: ${result.avgTime.toFixed(3)}ms`);
        console.log(`  Time per image: ${timePerImage.toFixed(3)}ms`);
        console.log(`  Range: ${result.minTime.toFixed(3)}ms - ${result.maxTime.toFixed(3)}ms`);
        console.log();
    });

    // Get final file sizes for comparison
    const initialStats = await fs.stat(tempCharpackPath);
    const finalVariations = await memoryPack.list();
    const addedCount = finalVariations.length - initialVariations.length;

    console.log('File Statistics:');
    console.log(`Initial variations: ${initialVariations.length}`);
    console.log(`Final variations: ${finalVariations.length}`);
    console.log(`Images added: ${addedCount}`);
    console.log(`Initial file size: ${initialStats.size} bytes`);

    // Cleanup
    memoryPack.dispose();
    await fs.unlink(tempCharpackPath);

    // Cleanup temp directory
    try {
        for (const file of testImages) {
            await fs.unlink(file);
        }
        await fs.rmdir(tempInputDir);
    } catch (error) {
        // Ignore cleanup errors
    }

    console.log('\nAdd performance test completed.');
}

// Run the test
if (require.main === module) {
    runAddPerformanceTest().catch(error => {
        console.error('Test failed:', error.message);
        process.exit(1);
    });
}

module.exports = { runAddPerformanceTest };
